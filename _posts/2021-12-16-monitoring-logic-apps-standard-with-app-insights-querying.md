---
layout: post
title: Monitoring Logic Apps Standard with Application Insights – Querying & Analysing Traces
date: 2021-12-16 10:00
author: Paco de la Cruz
comments: true
category: Logic Apps
tags: [Logic Apps, Application Insights, Azure, Observability]
---

<p><img src="/assets/img/2021/12/200-radio-telescope.webp" alt="Monitoring Logic Apps Standard with Application Insights – Querying &amp; Analysing Traces Part 3/3" width="800" loading="lazy" style="width: 800px;"></p>
<h2>Overview</h2>
<!--more-->
<p>In the <a href="/articles/monitoring-logic-apps-standard-with-app-insights-implementation" rel="noopener" target="_blank">previous post</a> of the series, we covered how to implement the different observability features that are available in Logic Apps Standard to send traces to Application Insights. In this post, we’ll discuss how to query and analyse these traces, and how to share these queries and publish query results. The series is structured as outlined below:</p>
<ul>
<li><a href="/monitoring-logic-apps-standard-with-app-insights-intro" rel="noopener" target="_blank"><strong>Introduction</strong></a> – describes the built-in observability features available in Logic Apps Standard.</li>
<li><a href="/monitoring-logic-apps-standard-with-app-insights-implementation" rel="noopener" target="_blank"><strong>Reference implementation</strong></a> – shows how these features can be leveraged and implemented.</li>
<li><strong>Querying and analysing Logic Apps traces (this article)</strong> – shows how to query and analyse Logic Apps application traces, and how to publish and share queries and charts.</li>
</ul>
<h2>Creating Queries</h2>
<p>As mentioned previously, Logic Apps Standard sends telemetry and diagnostic traces to Application Insights. Diagnostic traces can be queried and analysed using <a href="https://docs.microsoft.com/en-us/azure/data-explorer/kusto/query/?WT.mc_id=AZ-MVP-5003116" rel="noopener" target="_blank">Kusto Query Language (KQL)</a>. In this section, I’ll share some queries that can be used to troubleshoot and analyse Logic Apps run history.</p>
<p>As described in the <a href="/monitoring-logic-apps-standard-with-app-insights-implementation" rel="noopener" target="_blank">previous post</a>, some tracing properties that we’ll be getting through the query results are produced by the workflows by default and others are to be configured during the build phase. For instance, custom tracking id, tracked properties, custom error code, and custom error message are properties that must be configured while creating the workflow.</p>
<h3>Logic App Instances</h3>
<p>The query below returns Logic App instance details, including workflow run identifier, client tracking id, and workflow status. I've also included commented out query filters that can be leveraged to filter trace records. For instance, you can filter trace records using the Logic App name, workflow name, custom tracking id, or workflow status. I've included similar filters in most of the queries in this section.&nbsp;&nbsp;</p>
<pre>// Logic App instances with workflow run id, client tracking id, and workflow final status.<br>// If required, uncomment filters at the bottom and add filter values.<br>traces<br>| where operation_Name == "FlowRunLastJob"<br>| extend resource = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).resource))<br>| project timestamp<br> &nbsp; , LogicApp = tostring(cloud_RoleName)<br> &nbsp; , Workflow = tostring(resource.workflowName)<br> &nbsp; , WorkflowRunId = tostring(customDimensions.prop__flowRunSequenceId)<br> &nbsp; , ClientTrackingId = tostring(customDimensions.prop__clientTrackingId)<br> &nbsp; , WorkflowStatus = customDimensions.prop__status<br>| sort by timestamp desc<br>//| where LogicApp contains ""<br>//| where Workflow contains ""<br>//| where ClientTrackingId contains ""<br>//| where WorkflowStatus == "Succeeded"<br>//| where WorkflowStatus == "Failed"<br>//| where WorkflowStatus == "Cancelled"</pre>
<p style="text-align: center;">Code snippet 1 Querying Logic App workflow instances</p>
<p>&nbsp;</p>
<p>A sample result of this query is depicted below.</p>
<p><img src="/assets/img/2021/12/210-logic-app-instances-query-result.webp" alt="Logic App workflow instances query result" width="994" loading="lazy" style="width: 994px;"></p>
<p style="text-align: center;">Figure 1. Logic App workflow instances query result</p>
<h3>Logic App Instances with Tracked Properties</h3>
<p>The query below includes tracked properties. In the Logic App workflows that I showed in the <a href="/monitoring-logic-apps-standard-with-app-insights-implementation" rel="noopener" target="_blank">previous post</a>, I’m adding an interface identifier as a tracked property. This query shows how to retrieve that value.</p>
<p>Given that tracked properties are stored in a different trace record, we need to join two different traces using the workflow run identifier as shown below. In this query, I've added a commented out filter for a tracked property, which in this case is the interface identifier.&nbsp;</p>
<pre>// Logic App instances with workflow final status, workflow run id, client tracking id, and tracked properties.<br>// If required, uncomment filters at the bottom and add filter values.<br>traces<br>| where operation_Name == "FlowRunLastJob"<br>| extend resource = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).resource))<br>| project timestamp<br> &nbsp; , LogicApp = tostring(cloud_RoleName)<br> &nbsp; , Workflow = tostring(resource.workflowName)<br> &nbsp; , WorkflowRunId = tostring(customDimensions.prop__flowRunSequenceId)<br> &nbsp; , ClientTrackingId = tostring(customDimensions.prop__clientTrackingId)<br> &nbsp; , WorkflowStatus = customDimensions.prop__status<br>| join kind = leftouter ( // trackedProperties<br> &nbsp; traces<br> &nbsp; | where customDimensions.prop__properties has "trackedProperties"<br> &nbsp; | extend trackedProperties = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).trackedProperties))<br> &nbsp; | project InterfaceId = trackedProperties.InterfaceId<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; , WorkflowRunId = tostring(customDimensions.prop__flowRunSequenceId)<br> &nbsp; | where isnotnull(InterfaceId)<br> &nbsp; )<br> &nbsp; on $left.WorkflowRunId == $right.WorkflowRunId<br>| project timestamp<br> &nbsp; , LogicApp<br> &nbsp; , Workflow<br> &nbsp; , WorkflowRunId<br> &nbsp; , ClientTrackingId<br> &nbsp; , InterfaceId<br> &nbsp; , WorkflowStatus<br>| sort by timestamp desc<br>//| where LogicApp contains ""<br>//| where Workflow contains ""<br>//| where ClientTrackingId contains ""<br>//| where InterfaceId contains ""<br>//| where WorkflowStatus == "Succeeded"<br>//| where WorkflowStatus == "Failed"<br>//| where WorkflowStatus == "Cancelled"</pre>
<p style="text-align: center;">Code snippet 2. Querying tracked properties</p>
<p>&nbsp;</p>
<p>The figure below shows a sample result of the query.</p>
<p><img src="/assets/img/2021/12/221-logic-app-tracked-props-query-result.webp" alt="Sample query result including tracked properties" width="1133" loading="lazy" style="width: 1133px;"></p>
<p style="text-align: center;">Figure 2. Sample query result including tracked properties</p>
<h3>Failed Workflow Instances with Error Details</h3>
<p>In the workflows that I described in the <a href="/monitoring-logic-apps-standard-with-app-insights-implementation" rel="noopener" target="_blank">previous post</a>, as part of the reference implementation, I used error handling with <code>terminate</code> action that throws custom error codes and error messages.</p>
<p>The following query shows all the workflow instances that have failed including their error codes and error messages. Error codes and messages can be built-in or custom values defined in a <code>terminate</code> action.&nbsp;</p>
<pre>// Failed Logic App instances with workflow final status, workflow run id, client tracking id, and error details.<br>// If required, uncomment filters at the bottom and add filter values.<br>traces<br>| where operation_Name == "FlowRunLastJob"<br>| extend resource = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).resource))<br>| extend error = parse_json(tostring(customDimensions.prop__error))<br>| project timestamp<br> &nbsp; , LogicApp = tostring(cloud_RoleName)<br> &nbsp; , Workflow = tostring(resource.workflowName)<br> &nbsp; , WorkflowRunId = tostring(customDimensions.prop__flowRunSequenceId)<br> &nbsp; , ClientTrackingId = tostring(customDimensions.prop__clientTrackingId)<br> &nbsp; , WorkflowStatus = customDimensions.prop__status<br> &nbsp; , ErrorCode = error.code<br> &nbsp; , ErrorMessage = error.message&nbsp;&nbsp;<br>| join kind = leftouter ( // trackedProperties<br> &nbsp; traces<br> &nbsp; | where customDimensions.prop__properties has "trackedProperties"<br> &nbsp; | extend trackedProperties = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).trackedProperties))<br> &nbsp; | project InterfaceId = trackedProperties.InterfaceId<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; , WorkflowRunId = tostring(customDimensions.prop__flowRunSequenceId)<br> &nbsp; | where isnotnull(InterfaceId)<br> &nbsp; )<br> &nbsp; on $left.WorkflowRunId == $right.WorkflowRunId<br>| project timestamp<br> &nbsp; , LogicApp<br> &nbsp; , Workflow<br> &nbsp; , InterfaceId<br> &nbsp; , WorkflowRunId<br> &nbsp; , ClientTrackingId<br> &nbsp; , WorkflowStatus<br> &nbsp; , ErrorCode<br> &nbsp; , ErrorMessage<br>| sort by timestamp desc<br>| where WorkflowStatus == "Failed"<br>//| where InterfaceId contains ""<br>//| where ClientTrackingId contains ""<br>//| where LogicApp contains ""<br>//| where Workflow contains ""</pre>
<p style="text-align: center;">Code snippet 3. Querying failed workflow instances</p>
<p>&nbsp;</p>
<p>Below, you can see a sample result of said query.</p>
<p><img src="/assets/img/2021/12/231-logic-app-failed-instances-details-query-result.webp" alt="Sample query result of failed workflow instances including error code and error message" width="1639" loading="lazy" style="width: 1639px;"></p>
<p style="text-align: center;">Figure 3. Sample query result of failed workflow instances including error code and error message</p>
<h3>Troubleshooting a Logic App run instance</h3>
<p>After identifying a failed instance and noting its run instance identifier, the execution details of the workflow can be seen. For that, go to the workflow run history and search by the run identifier. If the workflow is stateful, inputs and outputs of the workflow run can also be seen, as shown in the clip below. I find this functionality very useful for troubleshooting.</p>
<p><img src="/assets/img/2021/12/211-troubleshooting.gif" alt="Opening up a workflow instance by its run identifier" width="1415" loading="lazy" style="width: 1415px;"></p>
<p style="text-align: center;">Figure 4. Opening up a workflow instance by its run identifier</p>
<h3>Failed Instances Count per Workflow</h3>
<p>The query below returns the count of failed instances per workflow summarised by day.</p>
<pre>traces<br>| where operation_Name == "FlowRunLastJob"<br>| extend resource = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).resource))<br>| project timestamp<br> &nbsp; , LogicApp = tostring(cloud_RoleName)<br> &nbsp; , Workflow = tostring(resource.workflowName)<br> &nbsp; , WorkflowStatus = tostring(customDimensions.prop__status)<br>| where WorkflowStatus == "Failed"<br>| summarize Count = count()<br> &nbsp; by bin(timestamp, 1d)<br> &nbsp; , Workflow</pre>
<p style="text-align: center;">Code snippet 4. Querying count of failed instances grouped per workflow</p>
<p>&nbsp;</p>
<p>The figure below depicts a sample stacked bar chart.</p>
<p><img src="/assets/img/2021/12/240-failed-workflow-count-chart.webp" alt="Failed workflow count chart" width="844" loading="lazy" style="width: 844px;"></p>
<p style="text-align: center;">Figure 5. Stacked bar chart of count of failed instances grouped per workflow</p>
<h3>Failed Trigger Details</h3>
<p>The query below returns the details of failed triggers.</p>
<pre>// Failed Logic App triggers.<br>// If required, uncomment filters at the bottom and add filter values.<br>traces<br>| where customDimensions.EventName == "WorkflowTriggerEnd"<br>| where customDimensions.prop__status == "Failed"<br>| sort by timestamp desc<br>| extend properties = parse_json(tostring(customDimensions.prop__properties))<br>| extend resource = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).resource))<br>| extend error = parse_json(tostring(customDimensions.prop__error))<br>| sort by timestamp desc<br>| project timestamp<br> &nbsp; , LogicApp = tostring(cloud_RoleName)<br> &nbsp; , Workflow = tostring(resource.workflowName)<br> &nbsp; , WorkflowRunId = tostring(customDimensions.prop__clientTrackingId)<br> &nbsp; , TriggerStatusCode = properties.code<br> &nbsp; , ErrorCode = tostring(error.code)<br> &nbsp; , ErrorMessage = tostring(error.message)<br> &nbsp; , message<br>//| where LogicApp contains ""<br>//| where Workflow contains ""<br>//| where TriggerStatusCode == ""<br>//| where ErrorCode == ""<br>//| where ErrorMessage contains ""<br>//| where Message contains ""</pre>
<p style="text-align: center;">Code snippet 5. Querying failed triggers</p>
<p>&nbsp;</p>
<p>A sample result is depicted below.</p>
<p><img src="/assets/img/2021/12/250-failed-trigger-details.webp" alt="Sample query result of failed triggers" width="1421" loading="lazy" style="width: 1421px;"></p>
<p style="text-align: center;">Figure 6. Sample query result of failed triggers</p>
<h3>Failed Trigger Count Per Workflow</h3>
<p>The query below returns the trigger count per workflow summarised per day.</p>
<pre>traces<br>| where customDimensions.EventName == "WorkflowTriggerEnd"<br>| where customDimensions.prop__status == "Failed"<br>| extend resource = parse_json(tostring(parse_json(tostring(customDimensions.prop__properties)).resource))<br>| project timestamp<br> &nbsp; , LogicApp = tostring(cloud_RoleName)<br> &nbsp; , Workflow = tostring(resource.workflowName)<br>| summarize Count = count()<br> &nbsp; by bin(timestamp, 1d),<br> &nbsp; Workflow<br>| render barchart<br>| sort by timestamp desc</pre>
<p style="text-align: center;">Code snippet 6. Querying count of failed triggers grouped per workflow</p>
<p>&nbsp;</p>
<p>This result set can be rendered as a stacked bar chart.</p>
<p><img src="/assets/img/2021/12/251-failed-trigger-chart.webp" alt="Stacked bar chart of count of failed triggers grouped per workflow" width="838" loading="lazy" style="width: 838px;"></p>
<p style="text-align: center;">Figure 7. Stacked bar chart of count of failed triggers grouped per workflow</p>
<h2>Saving and Sharing Queries</h2>
<p>If there is a need to save KQL queries and share them with the team, the best way to do it is using <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/logs/query-packs?WT.mc_id=AZ-MVP-5003116" rel="noopener" target="_blank">Azure Monitor query packs</a>. Query packs are a container for log queries that can be collaboratively created, updated, and shared across multiple users and workspaces. Query packs provide role-based access control with reader and contributor roles.</p>
<h2>Publishing Queries and Charts to an Azure Dashboard</h2>
<p>You can publish Application Insights query results and charts to an <a href="https://docs.microsoft.com/en-us/azure/azure-portal/azure-portal-dashboards?WT.mc_id=AZ-MVP-5003116" rel="noopener" target="_blank">Azure dashboard</a>. The <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/tutorial-app-dashboards?WT.mc_id=AZ-MVP-5003116" rel="noopener" target="_blank">official documentation</a> describes how to create a dashboard, how to pin log query results and charts to a dashboard, and how to share a dashboard.</p>
<p>The picture below depicts a dashboard that contains some of the queries and charts that I described above.</p>
<p><img src="/assets/img/2021/12/260-dashboard.webp" alt="Sample Azure dashboard with widgets created from Application Insights queries and charts" width="1643" loading="lazy" style="width: 1643px;"></p>
<p style="text-align: center;">Figure 8. Sample Azure dashboard with widgets created from Application Insights queries and charts</p>
<h2>Querying across multiple Application Insight Instances via Log Analytics Workspaces</h2>
<p>All the previous queries target traces sent to Application Insights. It is a common practice to create an Application Insights instance per Logic App. If queries are needed across multiple Logic Apps, the corresponding Application Insights can be configured to be <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/create-workspace-resource?WT.mc_id=AZ-MVP-5003116" rel="noopener" target="_blank">workspace-based</a>, which means that all the traces are ingested in a common Log Analytics workspace. This way queries that span across multiple Logic Apps can be run. When querying application traces in Log Analytics, the table name and some column names are different. The query below shows how to query Logic App traces using Log Analytics tables.</p>
<pre>AppTraces<br>| where OperationName == "FlowRunLastJob"<br>| extend resource = parse_json(tostring(parse_json(tostring(Properties.prop__properties)).resource))<br>| project TimeGenerated<br> &nbsp; , LogicApp = tostring(AppRoleName)<br> &nbsp; , Workflow = tostring(resource.workflowName)<br> &nbsp; , WorkflowRunId = tostring(resource.runId)<br> &nbsp; , ClientTrackingId = tostring(Properties.prop__clientTrackingId)<br> &nbsp; , WorkflowStatus = tostring(Properties.prop__status)<br>| sort by TimeGenerated desc</pre>
<p style="text-align: center;">Code snippet 7. Querying Logic App traces in Log Analytics</p>
<h2>Feedback to the Product Group</h2>
<p>In this series, we’ve seen how to implement some solution-level observability practices in Logic Apps Standard. Application Insights integration with Logic Apps is very useful. However, I believe there is still room for improvement. Below, I provide feedback for the product group to consider:</p>
<ul>
<li><strong>Show custom tracking identifier in the run history view for Logic Apps Standard</strong>. Currently, in the run history section of a Logic App workflow, we cannot see the client tracking id. It’d be very beneficial to show this value directly in the run history blade for troubleshooting purposes. If you think this is a good idea, please upvote it <a href="https://feedback.azure.com/d365community/idea/f39f8a74-6453-ec11-a819-0022484e8090" rel="noopener" target="_blank">here</a>.</li>
<li><strong>Add filtering capabilities in the run history view for Logic Apps Standard</strong>. Currently, the Logic Apps Standard run history provides basic sorting capabilities. However, it’d be very useful to be able to filter by date range, status, and client tracking id. If you think this is a good idea, please upvote it <a href="https://feedback.azure.com/d365community/idea/41316cb7-6453-ec11-a819-0022484e8090" rel="noopener" target="_blank">here</a>.</li>
<li><strong>Always flush tracked properties in Logic Apps Standard before a workflow finishes or is terminated</strong>. I’ve frequently seen that tracked properties are not always sent to Application Insights. Based on my experience, this can be mitigated if there is a delay action that prevents a workflow from finishing very soon after an action with tracked properties. However, I’d expect that tracked properties are reliably sent to Application Insights. If you think this is important, please upvote it <a href="https://feedback.azure.com/d365community/idea/f00353fa-6553-ec11-a819-0022484e8090" rel="noopener" target="_blank">here</a>.</li>
</ul>
<h2>Wrapping Up</h2>
<p>In the last post of the series, I’ve shown how to query application traces to help troubleshoot and analyse Logic Apps. I’ve also covered how to save and share queries, and how to publish and share result sets and charts. Finally, I shared how we can run queries across multiple Application Insights that are linked to the same Log Analytics workspace. I hope you’ve enjoyed and learned something useful from this blog series.</p>

<p>Happy monitoring!</p>

<p style="text-align:center;"><span style="font-style:italic;">Cross-posted on </span><a href="https://engineering.deloitte.com.au/articles/author/paco-de-la-cruz"><span style="font-style:italic;">Deloitte Engineering</span></a><br/>
<span style="font-style:italic;">Follow me on </span><a href="https://twitter.com/pacodelacruz"><span style="font-style:italic;">@pacodelacruz</span></a></p>